# WikipediaゴルフをLLMで解くシステム

目的: Wikipediaゴルフの「攻略本」をLLMを用いて作成する。

# Wikipediaゴルフについて

1人プレイのゲーム。Wikipediaからランダムに選んだ2つのページ（スタートとゴール）がシステムから提示される。
スタートからゴールまで、ページ内のリンクのみをたどって到達することを目指す。
得点は、リンクをクリックした回数。得点が小さいほうが好成績。
対象はWikipediaの日本語版。

# 実装したいもの
LLMを用いてWikipediaゴルフを解くシステムを実装する。

## ゲームのルール
LLMがプレイヤーとなるにあたってWikipediaゴルフのルールを詳細化する。

- スタートとゴールは、ランダムにページを返すAPIを利用して決定する。
- ページ本文は非常に長い場合があるため、ページの情報として与えるのは「ページ名」「リンク一覧（リンク先ページの名称）先頭から最大100個」とする。
- 1回の行動は、現在のページからリンクされているページのうちの1つか、移動履歴のうちの1つ（過去のページに戻る）を選択すること。
- 20回行動してゴールに到達しなければチャレンジ失敗。

## 動作の流れ
ゲーム1回のプレイの流れは以下の通り。
ゲーム1回は、一連のチャットセッションとしてLLMと対話する。また、入出力はプレーンテキストを用いて、structured outputは使用しない。システムプロンプトは使わず、ユーザプロンプトのみを生成する。すなわち、ChatGPTなどのインタラクティブなUIにロジック側の出力を張り付ければ再現可能な対話とする。

- システムがスタートとゴールのページをランダムに選択。
- 現在のページ＝スタート
- 現在のページに存在するリンクを抽出。
- LLMを実行。プロンプト:「ゲームのルール説明」+「攻略本」+「現在の状態の情報を指定し、行動出力を促す：現在のページ、移動履歴、リンク一覧」
- LLMの出力から行動を抽出。
- 現在のページ=選択された行動
  - 行動が不正な場合は、LLMを再実行する。
- LLMを実行。プロンプト:「対話履歴」+「現在の状態の情報を指定し、行動出力を促す」
- 以下、ゴールに到達するか失敗するまで繰り返す。
- LLMを実行。「対話履歴」+「今回のゲームを反省し、更新された攻略本を出力するよう促す」
- LLMの出力を新しい攻略本として保存。
  - 攻略本が適切でない（長すぎる）場合は、長すぎるので修正するようにプロンプトを与えて再生成させる。

LLMは、OpenRouter(OpenAI SDK使用)と、Geminiを直接使用する2系統を実装し、設定ファイルで使用するLLM、設定を指定可能にする。また、 .env ファイルでAPIキーを指定する。
LLMは思考過程の出力をしたうえで、最後に行動を出力する。

対話例。簡潔さのために省略しているため、実際にはより明確な指示を行うこと。攻略のヒントの部分に、生成された攻略本を挿入する。
移動先には過去の訪問ページも含まれるため、それを移動先の先頭に追加している。

```
user:
あなたはWikipediaゴルフをプレイします。
ルールは以下の通りです。...
このゲームのスタートは「東京」、ゴールは「富士山」です。

攻略のヒント:
- 年号は様々なページに飛びやすいです。

あなたは現在「東京」にいます。ゴールは「富士山」です。
選択できる移動先(|区切り): 東京都|日本|関東地方|江戸|国会議事堂|1823年|...
移動先を検討し、最後の行で移動先の1つを「移動先: 1823年」のように出力してください。

assistant:
富士山は東京にないため、より広い地域に移動したい。
移動先:関東地方

user:
あなたは現在「関東地方」にいます。ゴールは「富士山」です。
選択できる移動先(|区切り): 東京|日本|本州|茨城県|栃木県|静岡県|...
移動先を検討し、最後の行で移動先の1つを「移動先: 1823年」のように出力してください。

assistant:
富士山は静岡県にあるので、静岡県に移動したい。
移動先:静岡県

user:
あなたは現在「静岡県」にいます。ゴールは「富士山」です。
選択できる移動先(|区切り): 東京|静岡県|日本|中部地方|富士山...
移動先を検討し、最後の行で移動先の1つを「移動先: 1823年」のように出力してください。

assistant:
ゴールが見つかったので移動する。
移動先:富士山

user:
ゴールに到着しました。得点は3点でした。
今回のゲームを振り返り、攻略のヒントを改善してください。改善後の全文を出力し、それ以外のテキストは出力しないでください。条件は以下の通りです。
- 日本語で記述してください。
- 長さは1000文字以下にしてください。

assistant:
- 年号は様々なページに飛びやすいです。
- 場所を指す言葉がゴールの場合は、それを含む広い地域に移動すると有利です。
```

## ループの実装

徐々に攻略本を賢くしていくようなループを実装する。ある設定におけるループ全体の実行をexperimentと呼ぶ。
experimentは1つのディレクトリに配置する。そのファイル配置は以下の通り。
- config.yaml: 使用するLLM、ループ回数などの設定
- books (directory)
  - {iter}.txt: {iter}回目のプレイで出力された攻略本
- logs (directory)
  - {iter}.yaml: {iter}回目のプレイのログ

ループ処理
- 最初に、ゲームのルール説明およびこれに対する攻略本の初期版を作成するようLLMに指示し、出力を books/0.txt に保存する。
- for i in range(1, N+1):
  - 攻略本 `books/{i-1}.txt` をロードして使用する。
  - プレイを1回実施し、最終出力の攻略本を `books/{i}.txt` に保存する。
  - プレイログを `logs/{i}.yaml` に保存する。

プレイログについて
- チャットログと、ゲームロジックの履歴の2点を含めてください。

```
config: <configのコピー>
messages:
  - role: user
    message: "xxx"
  - role: assistant
    message: "yyy"
game:
  start: "東京"
  goal: "富士山"
  score: 3 # 失敗時は9999
  history:
    - current: "東京"
      candidates: ["東京","日本","関東地方","江戸",...]
      choice: "関東地方"
    - current: "関東地方"
      ...
cost: # input/output tokens
```

### 設定
- 使用するLLMのアクセス手段(openrouter,gemini)
- LLMの名前(openai/gpt-5-nano)
- LLMの追加オプション(temperatureなどdict)
- ループ回数
- ゲームルールの変更
  - 「数字を含むリンクは除外する」というルールを実装する。ゲームロジック側でフィルタリングを行ううえ、ゲームルールを説明するプロンプトでもルールの説明を追加する。

## 攻略本
日本語のテキストで、Wikipediaゴルフのテクニックを記載した1000文字以内のテキスト。

## 評価
あらかじめ、評価用データとしてスタートとゴールのペアを10通り用意しておく。

攻略本の良さは、評価用データにおける得点（小さいほうが良い）。

## コマンド

- experimentディレクトリを引数に指定し、ループを実行するコマンド。
- experimentディレクトリを引数に指定し、評価を実行するコマンド。
  - books/{i}.txt for i in range(1, 101, 20) を用いて、上記の評価を行い、プレイログを `evaluates` ディレクトリに出力する。評価の場合は最後の攻略本生成は省略する。
- 可視化用コマンド。gradioなどで作成する。
  - experimentを指定することで、各プレイの概要（スタート、ゴール、移動履歴、得点）を列挙して表示。
  - experiment内のプレイを選択することで、チャットログと、最終出力の攻略本を表示。

## 言語など

Python 3.12を使用する。仮想環境はuvで作成する。LLMへのアクセスは、OpenRouterを介する場合はOpenAI SDK (base urlを指定)、Geminiへ直接アクセスする場合は google-genai を使用する。

`.env` ファイルのAPIキーは、 `python-dotenv` ライブラリで読み込む。

## サンプルコード
WikipediaのAPIについては、 `sample/mediawiki.py` の実装を使用する。
このコードは今後削除されるため、コードをインポートするのではなく、コピーして使用すること。

# 初期実装の流れ
アプリケーション全体を実装してください。
アプリケーションの動作確認はネットワークアクセスが必須のため、escalationしてください。
`.env`ファイルにGeminiのAPIキーを記述しています。Geminiのモデル名"gemini-2.5-flash-lite"を使用する設定ファイルを実装し、これを用いてデバッグしてください。まず初期攻略本生成と1回のプレイをデバッグし、それからループ3回程度の動作を確認してください。ログ出力を確認し、LLMが明らかに問題のある(フォーマットを逸脱した)出力をしていればプロンプトの調整を試みてください。
